syntax = "proto3";

package redpanda.api.console.v1alpha1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "redpanda/api/auth/v1/authorization.proto";
import "redpanda/core/admin/v2/shadow_link.proto";

message CreateShadowLinkResponse {
  ShadowLink shadow_link = 1;
}

// Task states
enum TaskState {
  TASK_STATE_UNSPECIFIED = 0;
  // Task is active
  TASK_STATE_ACTIVE = 1;
  // Task was paused
  TASK_STATE_PAUSED = 2;
  // Task is unable to communicate with source cluster
  TASK_STATE_LINK_UNAVAILABLE = 3;
  // Task is not running
  TASK_STATE_NOT_RUNNING = 4;
  // Task is faulted
  TASK_STATE_FAULTED = 5;
}

// Status of a task
message ShadowLinkTaskStatus {
  // Name of the task
  string name = 1;
  // State of the task
  TaskState state = 2;
  // Reason for task being in state
  string reason = 3;
  // The broker the task is running on
  int32 broker_id = 4;
  // The shard the task is running on
  int32 shard_id = 5;
}

message ShadowLink {
  // Return name, configuration, and overall state
  string name = 1;
  string uid = 2;
  core.admin.v2.ShadowLinkConfigurations configurations = 3;
  core.admin.v2.ShadowLinkState state = 4;
  repeated ShadowLinkTaskStatus tasks_status = 5;
  repeated string synced_shadow_topic_properties = 6;
}

message ListShadowLinksRequest {
  message Filter {
    // Substring match on shadow link name. Case-sensitive.
    string name_contains = 1 [
      (buf.validate.field).string.max_len = 128,
      (buf.validate.field).string.pattern = "^[a-zA-Z0-9._\\-]*$"
    ];
  }

  Filter filter = 1;

  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: -1
      lte: 1000
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Limit the paginated response to a number of items. Defaults to 100. Use -1 to disable pagination."
      minimum: -1
      maximum: 1000
    }
  ];

  // Value of the next_page_token field returned by the previous response.
  // If not provided, the system assumes the first page is requested.
  string page_token = 3;
}

message ListShadowLinksResponse {
  message ShadowLink {
    string name = 1;
    core.admin.v2.ShadowLinkState state = 2;
    repeated string bootstrap_servers = 3;
  }

  repeated ShadowLink shadow_links = 1;
  string next_page_token = 2;
}

message UpdateShadowLinkResponse {}

message DeleteShadowLinkResponse {}

service ShadowLinkService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Shadow Links"
    description: "Manage Redpanda shadow links for disaster recovery and failover."
  };

  rpc CreateShadowLink(core.admin.v2.CreateShadowLinkRequest) returns (CreateShadowLinkResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/shadowlink"
      body: "shadow_link"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Create Shadow Link"
      description: "Create a new shadow link to replicate topics from a source cluster."
      responses: {
        key: "201"
        value: {
          description: "Shadow link created"
          schema: {
            json_schema: {ref: ".redpanda.api.console.v1alpha1.CreateShadowLinkResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_ADMIN
      api: API_REDPANDA_ADMIN
    };
  }

  rpc ListShadowLinks(ListShadowLinksRequest) returns (ListShadowLinksResponse) {
    option (google.api.http) = {get: "/v1alpha1/shadowlink"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List Shadow Links"
      description: "List all shadow links in the cluster. Optional: filter based on shadow link name."
      responses: {
        key: "200"
        value: {
          description: "OK"
          schema: {
            json_schema: {ref: ".redpanda.api.console.v1alpha1.ListShadowLinksResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_VIEW
      api: API_REDPANDA_ADMIN
    };
  }

  rpc UpdateShadowLink(core.admin.v2.UpdateShadowLinkRequest) returns (UpdateShadowLinkResponse) {
    option (google.api.http) = {
      patch: "/v1alpha1/shadowlink/{shadow_link.name}"
      body: "shadow_link"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Update Shadow Link"
      description: "Update an existing shadow link configuration."
      responses: {
        key: "200"
        value: {
          description: "Shadow link updated"
          schema: {
            json_schema: {ref: ".redpanda.api.console.v1alpha1.UpdateShadowLinkResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_ADMIN
      api: API_REDPANDA_ADMIN
    };
  }

  rpc DeleteShadowLink(core.admin.v2.DeleteShadowLinkRequest) returns (DeleteShadowLinkResponse) {
    option (google.api.http) = {delete: "/v1alpha1/shadowlink/{name}"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Delete Shadow Link"
      description: "Delete a shadow link by name."
      responses: {
        key: "204"
        value: {description: "Shadow link deleted"}
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_ADMIN
      api: API_REDPANDA_ADMIN
    };
  }
}
