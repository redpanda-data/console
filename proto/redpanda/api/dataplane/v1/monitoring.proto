syntax = "proto3";

package redpanda.api.dataplane.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/api/field_info.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "redpanda/api/auth/v1/authorization.proto";

enum KafkaConnectionState {
  KAFKA_CONNECTION_STATE_UNSPECIFIED = 0;
  KAFKA_CONNECTION_STATE_OPEN = 1;
  KAFKA_CONNECTION_STATE_ABORTING = 2;
  KAFKA_CONNECTION_STATE_CLOSED = 3;
}

enum AuthenticationState {
  AUTHENTICATION_STATE_UNSPECIFIED = 0;
  AUTHENTICATION_STATE_UNAUTHENTICATED = 1;
  AUTHENTICATION_STATE_SUCCESS = 2;
  AUTHENTICATION_STATE_FAILURE = 3;
}

enum AuthenticationMechanism {
  AUTHENTICATION_MECHANISM_UNSPECIFIED = 0;
  AUTHENTICATION_MECHANISM_MTLS = 1;
  AUTHENTICATION_MECHANISM_SASL_SCRAM = 2;
  AUTHENTICATION_MECHANISM_SASL_OAUTHBEARER = 3;
  AUTHENTICATION_MECHANISM_SASL_PLAIN = 4;
  AUTHENTICATION_MECHANISM_SASL_GSSAPI = 5;
}

message ListConnectionsRequest {
  enum OrderingOption {
    ORDERING_OPTION_UNSPECIFIED = 0;
    ORDERING_OPTION_OPEN_TIME = 1;
    ORDERING_OPTION_CLOSE_TIME = 2;
    ORDERING_OPTION_IDLE_DURATION = 3;
    ORDERING_OPTION_TOTAL_PRODUCE_THROUGHPUT = 4;
    ORDERING_OPTION_TOTAL_FETCH_THROUGHPUT = 5;
    ORDERING_OPTION_TOTAL_REQUESTS = 6;
    ORDERING_OPTION_LAST_MINUTE_PRODUCE_THROUGHPUT = 7;
    ORDERING_OPTION_LAST_MINUTE_FETCH_THROUGHPUT = 8;
    ORDERING_OPTION_LAST_MINUTE_REQUESTS = 9;
  }

  message Ordering {
    OrderingOption option = 1;
    bool descending = 2;
  }

  message Filters {
    KafkaConnectionState state = 1 [(buf.validate.field).enum.defined_only = true];
    string ip_address = 2;
    string client_id = 3;
    string client_software_name = 4;
    string client_software_version = 5;
    string group_id = 6;
    string user = 7;
    int64 idle_ms = 8 [(buf.validate.field).int64.gte = 0];
    string expression = 9;
  }

  Filters filters = 1;
  repeated Ordering order_by = 2;
  string order_by_expression = 3;
  uint32 limit = 4;
}

// Everything is up by one (produce is actually 0, fetch -> 1, etc)
enum KafkaAPI {
  KAFKA_API_UNSPECIFIED = 0;
  KAFKA_API_PRODUCE = 1;
  KAFKA_API_FETCH = 2;
  KAFKA_API_OFFSETS = 3;
  KAFKA_API_METADATA = 4;
  KAFKA_API_LEADER_AND_ISR = 5;
  KAFKA_API_STOP_REPLICA = 6;
  KAFKA_API_UPDATE_METADATA = 7;
  KAFKA_API_CONTROLLED_SHUTDOWN = 8;
  KAFKA_API_OFFSET_COMMIT = 9;
  KAFKA_API_OFFSET_FETCH = 10;
  KAFKA_API_GROUP_COORDINATOR = 11;
  KAFKA_API_JOIN_GROUP = 12;
  KAFKA_API_HEARTBEAT = 13;
  KAFKA_API_LEAVE_GROUP = 14;
  KAFKA_API_SYNC_GROUP = 15;
  KAFKA_API_DESCRIBE_GROUPS = 16;
  KAFKA_API_LIST_GROUPS = 17;
  KAFKA_API_SASL_HANDSHAKE = 18;
  KAFKA_API_API_VERSIONS = 19;
  KAFKA_API_CREATE_TOPICS = 20;
  KAFKA_API_DELETE_TOPICS = 21;
}

message ListConnectionsResponse {
  message ConnectionClient {
    string ip = 1;
    uint32 port = 2;
    string id = 3;
    string software_name = 4;
    string software_version = 5;
  }

  message APIVersion {
    KafkaAPI api = 1;
    int32 version = 2;
  }

  message ActiveRequests {
    message Request {
      KafkaAPI api = 1;
      google.protobuf.Duration duration = 2;
    }

    repeated Request requests = 1;
    bool has_more_requests = 2;
  }

  message GroupInfo {
    string id = 1;
    string instance_id = 2;
    string member_id = 3;
  }

  message AuthenticationInfo {
    AuthenticationState state = 1;
    AuthenticationMechanism mechanism = 2;
    string user_principal = 3;
  }

  message RequestStatistics {
    uint64 produce_bytes = 1;
    uint64 fetch_bytes = 2;
    uint64 request_count = 3;
    uint64 produce_batch_count = 4;
  }

  message Connection {
    int32 node_id = 1;
    uint32 shard_id = 2;
    string uid = 3 [(google.api.field_info).format = UUID4];
    KafkaConnectionState state = 4;
    google.protobuf.Timestamp open_time = 5;
    google.protobuf.Timestamp close_time = 6;
    google.protobuf.Duration connection_duration = 7;
    AuthenticationInfo authentication = 8;
    bool tls_enabled = 9;
    ConnectionClient client = 10;
    GroupInfo group = 11;
    string listener_name = 12;
    string transactional_id = 13;
    repeated APIVersion api_versions = 14;
    google.protobuf.Duration idle_duration = 15;
    ActiveRequests active_requests = 16;
    RequestStatistics request_statistics_all = 17;
    RequestStatistics request_statistics_1m = 18;
  }

  repeated Connection connections = 1;
}

service MonitoringService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Monitoring"
    description: "Monitoring operations for Redpanda."
  };

  rpc ListConnections(ListConnectionsRequest) returns (ListConnectionsResponse) {
    option (google.api.http) = {
      post: "/v1/monitoring/connections"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List Recent Connections"
      description: "List information on recent connections to the cluster."
      responses: {
        key: "200"
        value: {
          description: "Recent connections"
          schema: {
            json_schema: {ref: ".redpanda.api.dataplane.v1.ListConnectionsResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_ADMIN
      api: API_REDPANDA_ADMIN
    };
  }
}
