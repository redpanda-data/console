syntax = "proto3";

package redpanda.api.dataplane.v1alpha3;

import "google/api/annotations.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "redpanda/api/auth/v1/authorization.proto";

message Filter {
  string key = 1;
  string description = 2;
}

message QueryMetadata {
  string name = 1;
  // What this query returns
  string description = 2;
  // Unit of measurement for the returned time series
  string unit = 3;
  // Available filters for this query
  repeated Filter filters = 4;
}

message ListQueriesRequest {}

message ListQueriesResponse {
  repeated QueryMetadata queries = 1;
}

message DataPoint {
  google.protobuf.Timestamp timestamp = 1;
  double value = 2;
}

message TimeSeries {
  string name = 1;
  // Optional labels
  map<string, string> labels = 2;
  // Multiple for range queries, single item for instant queries
  repeated DataPoint values = 3;
}

message QueryRequest {
  string query_name = 1;
  // Optional - if not provided, performs an instant query at end time (or current time if both are absent)
  google.protobuf.Timestamp start = 2;
  // Optional - required if start is provided
  google.protobuf.Timestamp end = 3;
  // Query resolution step width (optional)
  google.protobuf.Duration step = 4;
  // Optional filter values to apply to the query
  map<string, string> filters = 5;
}

message QueryResponse {
  QueryMetadata metadata = 1;

  repeated TimeSeries result = 2;
}

service ObservabilityService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Observability"
    description: "Observability operations for Redpanda."
  };

  // List available queries
  rpc ListQueries(ListQueriesRequest) returns (ListQueriesResponse) {
    option (google.api.http) = {get: "/v1alpha3/observability/queries"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List Available Queries"
      description: "List all available predefined queries with their metadata (name, description, unit, and available filters)."
      responses: {
        key: "200"
        value: {
          description: "Queries metadata"
          schema: {
            json_schema: {ref: ".redpanda.api.dataplane.v1alpha3.ListQueriesResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_VIEW
      api: API_CONSOLE
    };
  }

  // Execute a predefined query
  rpc Query(QueryRequest) returns (QueryResponse) {
    option (google.api.http) = {
      post: "/v1alpha3/observability/query"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Execute Query"
      description: "Execute a predefined query. If start time is not provided, performs an instant query at the end time (or current time if both are absent). If start time is provided, performs a range query over the time range. Optional filters can be applied as key-value pairs."
      responses: {
        key: "200"
        value: {
          description: "Query results"
          schema: {
            json_schema: {ref: ".redpanda.api.dataplane.v1alpha3.QueryResponse"}
          }
        }
      }
    };
    option (redpanda.api.auth.v1.authorization) = {
      required_permission: PERMISSION_VIEW
      api: API_CONSOLE
    };
  }
}
