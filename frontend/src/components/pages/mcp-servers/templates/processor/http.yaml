label: weather-by-city
processors:
  - label: fetch_coords
    http:
      url: 'https://nominatim.openstreetmap.org/search?city=${! this.city_name }&format=json'
      verb: GET
      headers:
        Accept: application/json
        User-Agent: redpanda-mcp-server/1.0
  - label: prepare_coordinates
    mutation: |
      if this.length() < 1 {
        root = throw("could not find location of requested city")
      } else {
        meta lat = this.0.lat
        meta long = this.0.lon
      }
  - label: fetch_weather
    http:
      url: https://api.open-meteo.com/v1/forecast?latitude=${! @lat }&longitude=${! @long }&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,cloud_cover,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m&forecast_days=1
      verb: GET
      headers:
        Accept: application/json
        User-Agent: redpanda-mcp-server/1.0
  - label: format_response
    mutation: |
      root = {
        "forecast": this.current,
        "forecast_units": this.current_units,
        "metadata": {
          "source": "open-meteo.com",
          "fetched_at": now().ts_format("2006-01-02T15:04:05.000Z")
        }
      }

meta:
  mcp:
    enabled: true
    description: Fetch current weather information for a specified city. Do not pass anything beside city name.
    properties:
      - name: city_name
        type: string
        description: Only city name.
        required: true
